#pragma once

#include "common.h"


typedef std::map<DWORD, const wchar_t*> IoctlNamesMap;


class Driver {
	
	static constexpr size_t 		Max_Number_Of_Modules = 1000;
	
	const wstring& 					driverName;
	shared_ptr<HANDLE> 				driverHandle;
	DWORD							driverImageBase;
	DWORD							lastError;
	const IoctlNamesMap*			ioctlNamesMap;
	
public:
	Driver(
		const wstring& driverName, 
		const wstring& alternativeDrvName = L"",
		const IoctlNamesMap* ioctlNames = nullptr
	);
	
	~Driver();
	
	static DWORD GetModuleImageBase( const wstring &imageNameParam);
	
	// Returns tuple of <ImageBase, ImageSize, ModuleName>
	static tuple<ULONG, DWORD, wstring> GetKernelModuleInfos();
	
	operator!() {
		return (lastError != ERROR_SUCCESS);
	}
	
	DWORD getError() { 
		return lastError;
	}	
	
	bool SendIOCTL (
		DWORD ioctlCode, 
		LPVOID inputBuffer, 
		DWORD inputSize, 
		LPVOID outputBuffer = nullptr, 
		DWORD outSize = 0, 
		LPDWORD writtenBytes = nullptr,
		BOOL quiet = false
	);
	
	bool SendIOCTLQuiet (
		DWORD ioctlCode, 
		LPVOID inputBuffer, 
		DWORD inputSize, 
		LPVOID outputBuffer = nullptr, 
		DWORD outSize = 0, 
		LPDWORD writtenBytes = nullptr
	) {
		return SendIOCTL(ioctlCode, inputBuffer, inputSize, outputBuffer, outSize, writtenBytes, true);
	}
	
	HANDLE getRawDriverHandle() const {
		return (*driverHandle);
	}
};
